<https://www.oreilly.co.jp/books/9784873119656/>

# 8 スタイルガイドとルール

## 8.1 なぜルールを設けるのか

- 良い行動を促し悪い行動を思い止まらせるため

## 8.2 ルールを作る

- 鍵となる質問は「どんなルールを備えるべきか」ではなく、「どんなルールを前進させようとしているか」

## 8.2.1 指導原則

- ルールが膨大になると認知負荷が上がるので自明のルールは意図的にスタイルガイドから外す
- コードは書かれるより読まれる時間の方が圧倒的に多い
  - 読みづらくなるくらいなら、入力が退屈な方がまだまし
  - かくことが簡単であることより読むことが簡単であることを選ぶ
  - 強力な機能は専門家には理解は容易でもメンバーが扱えない場合もある。そのような場合は使用を避けるルールを設ける（とにかく使用と理解と保守が楽な方を選ぶ）
  - 一貫性はルールには重要だがスケールする場合に邪魔になることもある。トレードオフとして扱うべき

## 8.2.2 スタイルガイド

- スタイルガイドのカテゴリー
  - 危険を避けるべきルール
  - ベストプラクティスを矯正するためのルール
  - 一貫性を保証するためのルール
- 一貫性についてルールは、例えば空白が2文字なのか4文字なの、どちらを選択したかが重要なのではなく、選択した事実が重要

## 8.3 ルール変更

- 元々GoogleではC++エンジニアがPythonでスクリプトを書いており、そういった事情から変数名をキャメルケースでしていていた。しかし、Pythonエンジニアが増え、外部コミュニティとのつながりも深まる中でPythonのスタイルで標準的なスネークケースを利用してないことのコストが高まり、コミュニティからも懸念の目を向けられた。そこで、Googleはルール変更を行なった

## まとめ

- ルールとガイダンスが組織のスケーリングの鍵となる
- ルールの強制は自動化すると良い
- 人間が都度判断を行う方が合理的なものもあるので全てをルール化すると良いわけではない

# 9 コードレビュー

- レビューツールには、Critique, Gerritを使っている
- フロー
  - 最初にセルフレビューが入る。あとは一緒。
    - 最近はセルフレビューを忘れていたな
- コードレビューの恩恵
  - コードの正しさをチェックする
  - コードの変更が他のエンジニアにとって意味を把握できるものであることを保証する
  - コードベース全体での一貫性を強制する
  - チームのオーナーシップを心理的に促進する
  - 知識共有を可能にする
  - コードレビュー自体の履歴の記録を提供する
- コードの正しさ
  - 主観的なものではなく客観的なものであるべき
  - 認知負荷を減らす（意味の把握を促進する）、効率を増す、正しく動くことを保証する
  - 完璧を目指すよりは、コードベースを改善していく変更を受け入れる方が捗りやすい
- コードの意味の把握
  - コードレビューはある変更が拾い対象にとって理解可能かどうかを試す最初の試練
  - コードは書くより読まれる時間の方が圧倒的に多い（何度目だ
- コードの一貫性
  - 理解可能かつ保守可能となるように、コードベース全体を通した一貫性を保つ必要がある
  - レビューではコードの健全性、すなわち一貫性があり、保守性が保たれているかを見る必要がある
- 心理的ならびに文化的な恩恵
  - レビューはコードが個人のものではなく、集合的な事業の一部であるという認識を強化する
  - 最初は自分のコードへの批判的な意見に萎縮するが、徐々にレビューによる批判を予期するようになり、レビューを通じて得られるアドバイスと質問に価値を置くようになる
  - レビューの通過に必要な作業を強制することによって、仕事に蹴りをつけるようなコードやUnitテストの漏れなどを強制的に除外することができる
  - 小さな変更を書け （200行程度が小さい変更）

# 12 ユニットテスト

```
（Googleにおけるユニットテストの定義は１プロセスで動くことなので、一般的なスコープより広い）
リファクタ、新機能追加、バグ修正で変更が生じるテストは脆いテストで危険信号
インタラクションではなくステートに対してテストする
テストを明確にする
明確性：存在目的と失敗理由が自明であること
完全かつ簡潔に書く
完全：テストの結果に到達するための情報が全てテストに含まれる
簡潔：他の紛らわしい情報がテストに含まれていない
メソッドではなく挙動をテストする
〜という条件下で、〜となる場合、〜という結果になる と書く
上記のブロックごとにテストをまとめる
テストされる挙動を要約する形でテストを命名する
メソッド名に引っ張れない
Andが入ったら複数の挙動をテストしているので分割の可能性が高い
ロジックを入れない
テストのテストはできない
人間は簡単なものであれ、ロジックをチェックするのに向かない
テストでは気の利いたロジックより愚直でわかりやすいコード
失敗メッセージは、期待値と結果を明確に
理想はテストコードを追わなくても、レポートを読むだけで問題の原因を究明できること
テストコードは完全なDRYよりもDAMPを目指すべき
DAMP Descriptive And Meaningful Phrases 「説明的で分かりやすい言い回し」
テストは多少愚直でも、単純且つ明確であることのメリットの方が長期的に見て大きい
```
